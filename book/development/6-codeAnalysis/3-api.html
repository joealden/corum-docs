<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>API Analysis - Corum Project Report</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="The A Level Computing Coursework Project 'Corum' by Joe Alden">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <base href="../../">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme -->
        

        

        <!-- Fetch Clipboard.js from CDN but have a local fallback -->
        <script src="https://cdn.jsdelivr.net/clipboard.js/1.6.1/clipboard.min.js"></script>
        <script>
            if (typeof Clipboard == 'undefined') {
                document.write(unescape("%3Cscript src='clipboard.min.js'%3E%3C/script%3E"));
            }
        </script>

    </head>
    <body class="light">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme;
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            document.querySelector('html').classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li><a href="analysis/1-index/index.html"><strong aria-hidden="true">1.</strong> Analysis</a></li><li><ol class="section"><li><a href="analysis/2-idea/1-index.html"><strong aria-hidden="true">1.1.</strong> The Idea</a></li><li><ol class="section"><li><a href="analysis/2-idea/2-redditAlternative.html"><strong aria-hidden="true">1.1.1.</strong> Reddit Alterative</a></li><li><a href="analysis/2-idea/3-selfGoverning.html"><strong aria-hidden="true">1.1.2.</strong> Self Governing</a></li><li><a href="analysis/2-idea/4-openPlatform.html"><strong aria-hidden="true">1.1.3.</strong> Open Platform</a></li><li><a href="analysis/2-idea/5-modernInterface.html"><strong aria-hidden="true">1.1.4.</strong> Modern Interface</a></li></ol></li><li><a href="analysis/3-investigation/1-index.html"><strong aria-hidden="true">1.2.</strong> The Investigation</a></li><li><ol class="section"><li><a href="analysis/3-investigation/2-interviews.html"><strong aria-hidden="true">1.2.1.</strong> Interviews</a></li><li><a href="analysis/3-investigation/3-endUser.html"><strong aria-hidden="true">1.2.2.</strong> The End User</a></li><li><a href="analysis/3-investigation/4-focusGroup.html"><strong aria-hidden="true">1.2.3.</strong> The Focus Group</a></li><li><a href="analysis/3-investigation/5-existingSystems.html"><strong aria-hidden="true">1.2.4.</strong> Existing Systems</a></li></ol></li><li><a href="analysis/4-analysis/1-index.html"><strong aria-hidden="true">1.3.</strong> The Analysis</a></li><li><ol class="section"><li><a href="analysis/4-analysis/2-essentialFeatures.html"><strong aria-hidden="true">1.3.1.</strong> Essential Features</a></li><li><a href="analysis/4-analysis/3-computationalMethods.html"><strong aria-hidden="true">1.3.2.</strong> Computational Methods</a></li><li><a href="analysis/4-analysis/4-successCriteria.html"><strong aria-hidden="true">1.3.3.</strong> Success Criteria</a></li><li><a href="analysis/4-analysis/5-limitations.html"><strong aria-hidden="true">1.3.4.</strong> Limitations</a></li><li><a href="analysis/4-analysis/6-hardwareSoftware.html"><strong aria-hidden="true">1.3.5.</strong> Requirements</a></li></ol></li></ol></li><li><a href="design/1-index/index.html"><strong aria-hidden="true">2.</strong> Design</a></li><li><ol class="section"><li><a href="design/2-gui/index.html"><strong aria-hidden="true">2.1.</strong> GUI Design</a></li><li><a href="design/3-components/1-index.html"><strong aria-hidden="true">2.2.</strong> Component Design</a></li><li><ol class="section"><li><a href="design/3-components/2-logo.html"><strong aria-hidden="true">2.2.1.</strong> Logo</a></li><li><a href="design/3-components/3-header.html"><strong aria-hidden="true">2.2.2.</strong> Header</a></li><li><a href="design/3-components/4-navigation.html"><strong aria-hidden="true">2.2.3.</strong> Navigation</a></li><li><a href="design/3-components/5-main.html"><strong aria-hidden="true">2.2.4.</strong> Main Content</a></li><li><a href="design/3-components/6-footer.html"><strong aria-hidden="true">2.2.5.</strong> Footer</a></li></ol></li><li><a href="design/4-api/1-index.html"><strong aria-hidden="true">2.3.</strong> API Design</a></li><li><ol class="section"><li><a href="design/4-api/2-schema.html"><strong aria-hidden="true">2.3.1.</strong> API Schema</a></li></ol></li><li><a href="design/5-route/1-index.html"><strong aria-hidden="true">2.4.</strong> Route Design</a></li><li><ol class="section"><li><a href="design/5-route/2-summary.html"><strong aria-hidden="true">2.4.1.</strong> Route Summary</a></li><li><a href="design/5-route/3-home.html"><strong aria-hidden="true">2.4.2.</strong> Home Page</a></li><li><a href="design/5-route/4-login.html"><strong aria-hidden="true">2.4.3.</strong> Login Page</a></li><li><a href="design/5-route/5-signup.html"><strong aria-hidden="true">2.4.4.</strong> Signup Page</a></li><li><a href="design/5-route/6-subforum.html"><strong aria-hidden="true">2.4.5.</strong> Subforum Page</a></li><li><a href="design/5-route/7-post.html"><strong aria-hidden="true">2.4.6.</strong> Post Page</a></li><li><a href="design/5-route/8-newPost.html"><strong aria-hidden="true">2.4.7.</strong> New Post Page</a></li><li><a href="design/5-route/9-error.html"><strong aria-hidden="true">2.4.8.</strong> Error Page</a></li></ol></li><li><a href="design/6-testing/1-index.html"><strong aria-hidden="true">2.5.</strong> Testing</a></li><li><ol class="section"><li><a href="design/6-testing/2-linter.html"><strong aria-hidden="true">2.5.1.</strong> Linter</a></li><li><a href="design/6-testing/3-plan.html"><strong aria-hidden="true">2.5.2.</strong> Test Plan</a></li><li><a href="design/6-testing/4-data.html"><strong aria-hidden="true">2.5.3.</strong> Test Data</a></li><li><a href="design/6-testing/5-automation.html"><strong aria-hidden="true">2.5.4.</strong> Automated Testing</a></li></ol></li></ol></li><li><a href="development/1-index/index.html"><strong aria-hidden="true">3.</strong> Development</a></li><li><ol class="section"><li><a href="development/2-structure/1-index.html"><strong aria-hidden="true">3.1.</strong> Structure of Corum</a></li><li><ol class="section"><li><a href="development/2-structure/2-monolithMicro.html"><strong aria-hidden="true">3.1.1.</strong> Monolith vs Micro</a></li><li><a href="development/2-structure/3-client.html"><strong aria-hidden="true">3.1.2.</strong> Client Architecture</a></li><li><a href="development/2-structure/4-api.html"><strong aria-hidden="true">3.1.3.</strong> API Architecture</a></li></ol></li><li><a href="development/3-iterations/1-index.html"><strong aria-hidden="true">3.2.</strong> Iteration Stages</a></li><li><ol class="section"><li><a href="development/3-iterations/2-versionControl.html"><strong aria-hidden="true">3.2.1.</strong> Version Control</a></li><li><a href="development/3-iterations/3-changes.html"><strong aria-hidden="true">3.2.2.</strong> Iteration Stages</a></li><li><a href="development/3-iterations/4-feedback.html"><strong aria-hidden="true">3.2.3.</strong> User Feedback</a></li></ol></li><li><a href="development/4-problems/1-index.html"><strong aria-hidden="true">3.3.</strong> Problems experienced</a></li><li><ol class="section"><li><a href="development/4-problems/2-client.html"><strong aria-hidden="true">3.3.1.</strong> Client Problems</a></li><li><a href="development/4-problems/3-api.html"><strong aria-hidden="true">3.3.2.</strong> API Problems</a></li></ol></li><li><a href="development/6-codeAnalysis/1-index.html"><strong aria-hidden="true">3.4.</strong> Code Analysis</a></li><li><ol class="section"><li><a href="development/6-codeAnalysis/2-client.html"><strong aria-hidden="true">3.4.1.</strong> Client Analysis</a></li><li><a href="development/6-codeAnalysis/3-api.html" class="active"><strong aria-hidden="true">3.4.2.</strong> API Analysis</a></li></ol></li></ol></li><li><a href="evaluation/1-index/index.html"><strong aria-hidden="true">4.</strong> Evaluation</a></li><li><ol class="section"><li><a href="evaluation/2-testing/1-index.html"><strong aria-hidden="true">4.1.</strong> Testing</a></li><li><ol class="section"><li><a href="evaluation/2-testing/2-signup.html"><strong aria-hidden="true">4.1.1.</strong> Signup Page</a></li><li><a href="evaluation/2-testing/3-login.html"><strong aria-hidden="true">4.1.2.</strong> Login Page</a></li><li><a href="evaluation/2-testing/4-navigation.html"><strong aria-hidden="true">4.1.3.</strong> Navigation</a></li><li><a href="evaluation/2-testing/5-subforum.html"><strong aria-hidden="true">4.1.4.</strong> Subforum Page</a></li><li><a href="evaluation/2-testing/6-post.html"><strong aria-hidden="true">4.1.5.</strong> Post Page</a></li><li><a href="evaluation/2-testing/7-newPost.html"><strong aria-hidden="true">4.1.6.</strong> New Post Page</a></li><li><a href="evaluation/2-testing/8-newSubforum.html"><strong aria-hidden="true">4.1.7.</strong> New Subforum Page</a></li></ol></li><li><a href="evaluation/3-usabilityFeatures/1-index.html"><strong aria-hidden="true">4.2.</strong> Usability Features</a></li><li><a href="evaluation/4-evaluation/1-index.html"><strong aria-hidden="true">4.3.</strong> Final Evaluation</a></li></ol></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="submenu">
                                <li><button class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li><button class="theme" id="rust">Rust</button></li>
                                <li><button class="theme" id="coal">Coal</button></li>
                                <li><button class="theme" id="navy">Navy</button></li>
                                <li><button class="theme" id="ayu">Ayu</button></li>
                            </ul>
                        </div>

                        <h1 class="menu-title">Corum Project Report</h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="development/6-codeAnalysis/3-api.html#api-analysis" id="api-analysis"><h1>API Analysis</h1></a>
<a class="header" href="development/6-codeAnalysis/3-api.html#api-schema" id="api-schema"><h2>API Schema</h2></a>
<p>The schema of the API was created during the design phase of the project.
However, so it is easier to understand the code in this section, I will repeat
it here:</p>
<pre><code class="language-graphql">type User @model {
  id: ID! @isUnique
  username: String! @isUnique
  email: String! @isUnique
  password: String!
  posts: [Post!]! @relation(name: &quot;UserToPost&quot;)
  votes: [Vote!]! @relation(name: &quot;UserToVote&quot;)
  favorites: [Favorite!]! @relation(name: &quot;UserToFavorite&quot;)
}

type Subforum @model {
  id: ID! @isUnique
  url: String! @isUnique
  name: String!
  posts: [Post!]! @relation(name: &quot;SubforumToPost&quot;)
  favorites: [Favorite!]! @relation(name: &quot;SubforumToFavorite&quot;)
}

type Favorite @model {
  id: ID! @isUnique
  user: User! @relation(name: &quot;UserToFavorite&quot;)
  subforum: Subforum! @relation(name: &quot;SubforumToFavorite&quot;)
}

type Post @model {
  id: ID! @isUnique
  subforum: Subforum! @relation(name: &quot;SubforumToPost&quot;)
  title: String!
  author: User! @relation(name: &quot;UserToPost&quot;)
  content: String!
  voteCount: Int
  createdAt: DateTime!
  comments: [Comment!]! @relation(name: &quot;PostToComment&quot;)
  votes: [Vote!]! @relation(name: &quot;PostToVote&quot;)
}

type Comment @model {
  id: ID! @isUnique
  post: Post! @relation(name: &quot;PostToComment&quot;)
  author: String!
  content: String!
}

type Vote @model {
  id: ID! @isUnique
  post: Post! @relation(name: &quot;PostToVote&quot;)
  user: User! @relation(name: &quot;UserToVote&quot;)
  vote: VoteType!
}

enum VoteType {
  VOTE_UP
  VOTE_DOWN
}
</code></pre>
<p>Here is a graphical representation of the schema above:</p>
<p><img src="images/api-schema-graph-view.png" alt="Graph View of API Schema" /></p>
<a class="header" href="development/6-codeAnalysis/3-api.html#permission-configuration" id="permission-configuration"><h2>Permission Configuration</h2></a>
<pre><code class="language-yml"># Where 'authenticated: true' is present in an operation,
# the client must pass along their JWT auth token in the
# request headers. (In the form -&gt; Authorization: 'Bearer ${TOKEN}')

permissions:
    # User Permissions

    # Allows access to User from Post
    # Only the username field is made queryable. This means
    # that malicious users cannot query for someones elses
    # information such as their password, id, or email.
  - operation: User.read  
    fields: [username]

  # Subforum Permissions
  - operation: Subforum.create
    authenticated: true
  - operation: Subforum.read

  # Favorite Permissions
  - operation: Favorite.create
    authenticated: true
  - operation: Favorite.read
  - operation: Favorite.delete
    authenticated: true

  # Post Permissions
  - operation: Post.create
    authenticated: true
  - operation: Post.read

  # Comment Permissions
  - operation: Comment.create
    authenticated: true
  - operation: Comment.read

  # Vote Permissions
  - operation: Vote.create
    authenticated: true
  - operation: Vote.read
  - operation: Vote.update
    authenticated: true
  - operation: Vote.delete
    authenticated: true

  # Relation Permissions
  - operation: SubforumToPost.connect
    authenticated: true
  - operation: PostToComment.connect
    authenticated: true
  - operation: UserToPost.connect
    authenticated: true
  - operation: UserToVote.connect
    authenticated: true
  - operation: PostToVote.connect
    authenticated: true
  - operation: UserToFavorite.connect
    authenticated: true
  - operation: SubforumToFavorite.connect
    authenticated: true
</code></pre>
<p>As mentioned in the '<a href="development/6-codeAnalysis/3-api.html#how-graphcool-works">How Graphcool Works</a>' section,
graphcool needs a configuration file called <code>graphcool.yml</code>. Most of this file
is just boilerplate to link the below hook functions into graphcool, however a
very important part of this file is the <code>permissions</code> section.</p>
<p>This section allows you to define exactly who can do what with the API. This is
crucial to the proper functioning of Corum as it stops non authenticated users
from doing things like creating posts, creating comments and voting on posts.</p>
<p>This configuration file is written in <code>yml</code>, which you may not be that familiar
with. Here are the basics that are put to use in this file:</p>
<ul>
<li><code>#</code> starts a comment</li>
<li><code>-</code> starts an object</li>
</ul>
<p>So in this file, <code>permissions</code> is a list of objects. Each object in the
<code>permissions</code> array specifies the <code>operation</code> to configure. The operations that
can be configured are derived from the API schema. (Linked above)</p>
<p>For example, The <code>Vote</code> data type found in the schema can have the following
operations configured:</p>
<ul>
<li><code>Vote.create</code></li>
<li><code>Vote.read</code></li>
<li><code>Vote.update</code></li>
<li><code>Vote.delete</code></li>
</ul>
<p>These operations are found on every data type in the schema. (Which are CRUD
operations) You can also specify permissions for relations. This is important
because creating a relationship between data types means that both data type
instances are mutated. For example, the following operations can be specified
for the <code>UserToPost</code> relation which links a user to the post they created:</p>
<ul>
<li><code>UserToPost.connect</code></li>
<li><code>UserToPost.Disconnect</code></li>
</ul>
<p>If a certain operation is not specified, (for example, there is not
<code>Favorite.update</code> operation in this configuration) then nothing (expect hook
functions given root tokens) can perform this operation.</p>
<p>If an object in the <code>permissions</code> section specifies an <code>authenticated</code> property
of <code>true</code>, the operation can only be performed by authenticated users (Users
that are logged in)</p>
<p>If an object in the <code>permission</code> section specifies a <code>field</code> property, then
operation is restricted to only the values found in the array passed to it. For
example, in Corum's API, anyone can read from the <code>Username</code> data type, however
they can only read the <code>username</code> field.</p>
<a class="header" href="development/6-codeAnalysis/3-api.html#hook-functions" id="hook-functions"><h2>Hook Functions</h2></a>
<a class="header" href="development/6-codeAnalysis/3-api.html#userandsubforumisunique" id="userandsubforumisunique"><h3><code>userAndSubforumIsUnique</code></h3></a>
<pre><code class="language-js">import { fromEvent } from 'graphcool-lib'
import { makeRequest } from '../../utils/common'

/*
  This is a hook function that executes every time before a favorite is created.
  It ensures that only 1 favorite of a subforum by a single user can happen.
*/

const favoriteQuery = `
query FavoriteQuery($userId: ID!, $subforumId: ID!) {
  allFavorites(
    filter: { AND: [{ user: { id: $userId } }, { subforum: { id: $subforumId } }] }
  ) {
    id
  }
}
`

export default async event =&gt; {
  try {
    // Create Graphcool API (based on https://github.com/graphcool/graphql-request)
    const api = fromEvent(event).api('simple/v1')

    // Retrieve payload from event
    const { data } = event
    const { userId, subforumId } = data

    const { allFavorites } = await makeRequest(api, favoriteQuery, {
      userId,
      subforumId
    })

    if (allFavorites.length === 0) {
      return { data }
    } else {
      return { error: 'This user has already favorited this subforum' }
    }
  } catch (error) {
    return { error }
  }
}
</code></pre>
<p>As mentioned in the comment at the top of this file, This hook function ensures
that only 1 favorite of a subforum by a single user can happen, and it is run
every time before a favorite is created. There is also a hook function called
<code>userAndPostIsUnique</code> is very similar. Instead of ensuring that only unique
favorites can be added, it ensures that only unique votes can be made on a post.
As this hook function is so similar, I will only analyse this hook function.</p>
<p>Variable Reference:</p>
<ul>
<li><code>favoriteQuery</code> is the GraphQL query used to check if the user has already
favorited of this subforum.</li>
<li><code>event</code>this is an object containing all of the information about the query or
mutation event we are hooking into.</li>
<li><code>fromEvent</code> is a function exposed by the library <code>graphcool-lib</code> that
constructs a GraphQL client from the <code>event</code> data passed into the function.
This allows us to send queries and mutations to the API from within the API
code.</li>
<li><code>makeRequest</code> is an abstraction of a function provided by <code>graphcool-lib</code> that
allows us to send queries and mutations to the API. The exact implementation
of this function is described later on.</li>
</ul>
<p>First, <code>fromEvent</code> and <code>makeRequest</code> are imported so that they can be used in
this file. Next, we export a function that expects the <code>event</code> argument. The
reason we do this is because graphcool expects hook function files to export a
function that it can call when needed.</p>
<p>Within this function, using the <code>fromEvent</code> function, a reference to the API is
created from the <code>event</code> data and assigned to the variable <code>api</code>. This variable
will be passed into the <code>makeRequest</code> function so that it knows what API to make
the request to.</p>
<p>Next, the data the client submitted to the API is extracted from the <code>data</code>
property of the <code>event</code> argument. For this hook function, we extract <code>userId</code>
and <code>subforumId</code>. Then, a call to the <code>makeRequest</code> function is made, passing in
the API reference created earlier, the GraphQL query that we want to execute,
along with the variable needed to perform the query. In this case, both the
<code>userId</code> and <code>subforumId</code> are passed as variables to the query.</p>
<p>Once the query has successfully been executed, the function will return the data
response. In this case, we are only interested in the <code>allFavorites</code> value that
is returned. This is an array of <code>Favorite</code> objects that belong to the user and
match the subforum they are attempting to create a favorite for. This means that
if the array has any <code>Favorite</code> objects in it, the user has already favorited
this subforum.</p>
<p>This check is made by checking if the length of the array is 0. (empty) If the
array is empty, then the user has not favorited this subforum already, so they
should allow to favorite it. In this case, the data submitted by the user is
saved to the database. If the length of the array is anything other than 0, then
user should not be allowed to create a favorite. An error is returned to the
user and the data is not saved.</p>
<a class="header" href="development/6-codeAnalysis/3-api.html#initvotecount" id="initvotecount"><h3><code>initVoteCount</code></h3></a>
<pre><code class="language-js">// Ensures that when a post is created, the vote Count is set to 0

export default event =&gt; {
  const { data } = event
  data.voteCount = 0
  return { data }
}
</code></pre>
<p>This is the simplest hook function used in Corum. As mentioned in the code
comment, when a <code>Post</code> is created, the <code>voteCount</code> field on it is set to 0. This
is so that malicious users cannot initialise a post with however many votes they
want.</p>
<a class="header" href="development/6-codeAnalysis/3-api.html#updatevotecountonvotecreation" id="updatevotecountonvotecreation"><h3><code>updateVoteCountOnVoteCreation</code></h3></a>
<pre><code class="language-js">import { fromEvent } from 'graphcool-lib'
import {
  VOTE_COUNT_TO_DELETE_POST,
  makeRequest,
  deleteAllVotesOnPost,
  postIdFromVoteQuery,
  currentPostVoteCount,
  getAllVoteIdsOnPost,
  deleteVote,
  deletePost,
  updatePost
} from '../../utils/common'

/*
  This is a hook function that executes every time after a vote is created.
  It updates the voteCount field on the post to reflect the vote creation.
  Also, if the new vote count is equal or less than the VOTE_COUNT_TO_DELETE_POST
  constant, then the post will be deleted (The automated management system)
*/

export default async event =&gt; {
  try {
    // Create Graphcool API (based on https://github.com/graphcool/graphql-request)
    const api = fromEvent(event).api('simple/v1')

    // Retrieve payload from event
    const { data } = event
    const voteId = data.id
    const voteType = data.vote

    const { Vote } = await makeRequest(api, postIdFromVoteQuery, { voteId })
    const postId = Vote.post.id

    const { Post } = await makeRequest(api, currentPostVoteCount, { postId })
    const oldVoteCount = Post.voteCount

    let newVoteCount
    if (voteType === 'VOTE_UP') {
      newVoteCount = oldVoteCount + 1
    } else if (voteType === 'VOTE_DOWN') {
      newVoteCount = oldVoteCount - 1
    } else {
      return Promise.reject('voteType is invalid or is not defined')
    }

    if (newVoteCount &lt;= VOTE_COUNT_TO_DELETE_POST) {
      await deleteAllVotesOnPost(api, postId)
      return await makeRequest(api, deletePost, { postId })
    } else {
      return await makeRequest(api, updatePost, { postId, newVoteCount })
    }
  } catch (error) {
    return { error }
  }
}
</code></pre>
<p>As mentioned at the top of this file, this hook function executes every time
after a <code>Vote</code> is created. It updates the <code>voteCount</code> field on the post to
reflect the vote creation. Also, if the new vote count is equal or less than the
<code>VOTE_COUNT_TO_DELETE_POST</code> constant, then the post will be deleted (The
automated management system)</p>
<p>As this check has to be made on every possible CRUD operation that may modify
the overall vote count, there are also hook functions for when a vote is updated
or deleted called <code>updateVoteCountOnVoteUpdate</code> and
<code>updateVoteCountOnVoteDeletion</code> respectively. These hook functions are very
similar, so I will only be analysing the 'creation' version of the hook
functions as shown above.</p>
<p>Variable Reference:</p>
<ul>
<li><code>event</code>this is an object containing all of the information about the query or
mutation event we are hooking into.</li>
<li><code>fromEvent</code> is a function exposed by the library <code>graphcool-lib</code> that
constructs a GraphQL client from the <code>event</code> data passed into the function.
This allows us to send queries and mutations to the API from within the API
code.</li>
<li><code>makeRequest</code> is an abstraction of a function provided by <code>graphcool-lib</code> that
allows us to send queries and mutations to the API. The exact implementation
of this function is described later on.</li>
<li><code>deleteAllVotesOnPost</code> is a function that as the name suggests, deletes all
votes on a post. The implementation of this function is described later on.</li>
<li><code>postIdFromVoteQuery</code> is GraphQL query that fetches the post's ID that a vote
was made on.</li>
<li><code>currentPostVoteCount</code> is a GraphQL query that fetches the the current vote
count of a post.</li>
<li><code>getAllVoteIdsOnPost</code> is a GraphQL query that fetches all votes that exist on
a post.</li>
<li><code>deleteVote</code> is a GraphQL mutation that deletes a vote.</li>
<li><code>deletePost</code> is a GraphQL mutation that deletes a post.</li>
<li><code>updatePost</code> is a GraphQL mutation that updates a post with a new post count.</li>
</ul>
<p>Like the first hook function shown in this section, this function imports what
it needs and exports a function for graphcool. Also like the first hook
function, a reference to the API is created and the user data is extracted.</p>
<p>This time, <code>voteId</code> and <code>voteType</code> are extracted from the data object. Next, a
request is made to get the post ID using the <code>voteId</code> variable. When the API
responds, the post ID fetched is used to fetch the current vote count on that
post.</p>
<p>Then, depending on how the user voted, (determined by the contents of the
<code>voteType</code> variable) A new vote count is created. If the user upvoted the post,
the vote count is increment by 1. If the user downvoted the post, the vote count
is decremented by 1. There is also error handling if they somehow submitted an
incorrect vote type.</p>
<p>If <code>voteType</code> was defined, the function continues and goes on to update the post
data stored in the database. This is where the automated management system
works. If the new vote count is less than or equal to the defined threshold
stored in <code>VOTE_COUNT_TO_DELETE_POST</code>, the post is deleted along with all of the
votes that were linked to it. Otherwise, the post is updated with the new vote
count.</p>
<a class="header" href="development/6-codeAnalysis/3-api.html#resolvers" id="resolvers"><h2>Resolvers</h2></a>
<p>Resolvers are the most powerful way to extend grapcool. They make it so that you
can add extra queries and mutations to the API. In the case of Corum, only two
custom resolvers are needed. One to sign up users and one to authenticate users.</p>
<a class="header" href="development/6-codeAnalysis/3-api.html#authenticate" id="authenticate"><h3><code>authenticate</code></h3></a>
<pre><code class="language-js">import { fromEvent } from 'graphcool-lib'
import * as bcryptjs from 'bcryptjs'
import { makeRequest } from '../../utils/common'

const userQuery = `
  query UserQuery($email: String!) {
    User(email: $email) {
      id
      password
      username
    }
  }
`

export default async event =&gt; {
  try {
    // Retrieve payload from event
    const { email, password } = event.data

    // Create Graphcool API (based on https://github.com/graphcool/graphql-request)
    const graphcool = fromEvent(event)
    const api = graphcool.api('simple/v1')

    // Check if a user exists with the email entered
    const { User } = await makeRequest(api, userQuery, { email })
    if (!User) {
      return { error: 'Invalid credentials!' }
    }

    // Check if the user entered the correct password for the user
    const passwordIsCorrect = await bcryptjs.compare(password, User.password)
    if (!passwordIsCorrect) {
      return { error: 'Invalid credentials!' }
    }

    // Generate auth token
    const { id, username } = User
    const token = await graphcool.generateAuthToken(id, 'User')

    // Return the payload the user asked for
    return {
      data: {
        id,
        username,
        token
      }
    }
  } catch (error) {
    return { error }
  }
}
</code></pre>
<p>This is the resolver used to authenticate users that have already created an
account.</p>
<a class="header" href="development/6-codeAnalysis/3-api.html#signup" id="signup"><h3><code>signup</code></h3></a>
<pre><code class="language-js">import { fromEvent } from 'graphcool-lib'
import * as bcryptjs from 'bcryptjs'
import * as validator from 'validator'
import { makeRequest } from '../../utils/common'

const userQuery = `
  query UserQuery($email: String!, $username: String!) {
    allUsers(filter: { OR: [{ email: $email }, { username: $username }] }) {
      id
      password
      email
      username
    }
  }
`

const createUserMutation = `
  mutation CreateUserMutation(
    $username: String!
    $email: String!
    $passwordHash: String!
  ) {
    createUser(username: $username, email: $email, password: $passwordHash) {
      id
    }
  }
`

export default async event =&gt; {
  // Retrieve payload from event
  const { username, email, password } = event.data

  // Create Graphcool API (based on https://github.com/graphcool/graphql-request)
  const graphcool = fromEvent(event)
  const api = graphcool.api('simple/v1')

  const SALT_ROUNDS = 10

  try {
    // Check is email is valid
    if (validator.isEmail(email) === false) {
      return { error: 'The email address entered is not valid' }
    }

    // Fetch all users that match the users input (if any)
    const { allUsers } = await makeRequest(api, userQuery, { email, username })

    // If no users exists with the same details, create the user
    if (allUsers.length === 0) {
      // Generate the password hash that will be stored in the DB
      const passwordHash = await bcryptjs.hash(password, SALT_ROUNDS)

      // Create the user
      const { createUser } = await makeRequest(api, createUserMutation, {
        email,
        username,
        passwordHash
      })

      // Generate auth token
      const { id } = createUser
      const token = await graphcool.generateAuthToken(id, 'User')

      // Return the payload the user asked for
      return {
        data: {
          id,
          token
        }
      }
    }

    // If any users do exist, throw the correct informative error
    if (
      allUsers.length === 2 ||
      (allUsers[0].email === email &amp;&amp; allUsers[0].username === username)
    ) {
      return { error: 'The email address and username are in use' }
    } else if (allUsers[0].email === email) {
      return { error: 'The email address is in use' }
    } else if (allUsers[0].username === username) {
      return { error: 'The username is in use' }
    } else {
      return { error: 'An unknown error occured' }
    }
  } catch (error) {
    return { error }
  }
}
</code></pre>
<p>placeholder</p>
<a class="header" href="development/6-codeAnalysis/3-api.html#utility-functions-and-constants" id="utility-functions-and-constants"><h2>Utility Functions and Constants</h2></a>
<a class="header" href="development/6-codeAnalysis/3-api.html#vote_count_to_delete_post" id="vote_count_to_delete_post"><h3><code>VOTE_COUNT_TO_DELETE_POST</code></h3></a>
<pre><code class="language-js">export const VOTE_COUNT_TO_DELETE_POST = -1
</code></pre>
<p>This number determines the amount of votes required for the post to be deleted
by the automatic post management system.</p>
<a class="header" href="development/6-codeAnalysis/3-api.html#makerequest" id="makerequest"><h3><code>makeRequest</code></h3></a>
<pre><code class="language-js">/*
  A wrapper around the fromEvent(event).request that is provided
  by 'graphcool-lib' to handle errors in query responses.
*/
export const makeRequest = async (api, query, variables) =&gt; {
  const queryResult = await api.request(query, variables)

  if (queryResult.error) {
    return Promise.reject(queryResult.error)
  } else {
    return queryResult
  }
}
</code></pre>
<p>placeholder</p>
<a class="header" href="development/6-codeAnalysis/3-api.html#deleteallvotesonpost" id="deleteallvotesonpost"><h3><code>deleteAllVotesOnPost</code></h3></a>
<pre><code class="language-js">/*
  Currently, the CRUD API generated by graphcool does not expose a
  query that allows you to update or delete multiple data records at
  once.

  It looks like this feature is coming in the graphcool 1.0 release.
  https://github.com/graphcool/framework/issues/81

  In the meantime, this function will be used to delete all the Votes
  on a Post record. This is required because graphcool doesn't allow
  you to delete records that would leave other records orphans.

  In the case of the Post type, if it was deleted, it would leave the
  Vote records that reference the Post, orphans. To allow us to delete
  a post, we must first delete the Votes that reference it.
*/
export const deleteAllVotesOnPost = async (api, postId) =&gt; {
  const { allVotes } = await makeRequest(api, getAllVoteIdsOnPost, { postId })
  const voteIdList = allVotes.map(vote =&gt; vote.id)

  return await Promise.all(
    voteIdList.map(voteId =&gt; {
      return makeRequest(api, deleteVote, { voteId })
    })
  )
}
</code></pre>
<p>placeholder</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="development/6-codeAnalysis/2-client.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="evaluation/1-index/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="development/6-codeAnalysis/2-client.html" class="nav-chapters previous" title="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="evaluation/1-index/index.html" class="nav-chapters next" title="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if (getComputedStyle(document.querySelector(".fa")).fontFamily !== "FontAwesome") {
                var link = document.createElement('link');
                link.rel = 'stylesheet';
                link.type = 'text/css';
                link.href = '_FontAwesome/css/font-awesome.css';
                document.head.insertBefore(link, document.head.firstChild)
            }
        </script>

        

        

        

        

        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS script -->
        

    </body>
</html>
